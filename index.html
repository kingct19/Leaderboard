<script>
  async function loadLeaderboard() {
    const sheetUrl = "https://opensheet.elk.sh/14b6UQtCINY8HQ6zd03PocOkuax1dIcQHmrR_EoYsTHA/Leaderboard";
    try {
      const res = await fetch(sheetUrl);
      const data = await res.json();
      console.log("Fetched Data:", data);

      const leaderboardDiv = document.getElementById("leaderboard");
      leaderboardDiv.innerHTML = "";

      const sorted = data
        .filter(row => row['Name'] && !isNaN(parseInt((row['Deals This Month'] || '').trim())))
        .map((row, i) => {
          const currentRank = parseInt((row['Current Rank'] || '').trim());
          const lastRank = parseInt((row['Last Week Rank'] || '').trim());
          let trend = "⏺️";
          if (!isNaN(lastRank)) {
            if (lastRank > currentRank) trend = "🔼";
            else if (lastRank < currentRank) trend = "🔽";
          }

          return {
            rank: ["🥇", "🥈", "🥉"][i] || `#${i + 1}`,
            name: row['Name'].trim(),
            role: (row['Role'] || '').trim(),
            count: parseInt((row['Deals This Month'] || '').trim()) || 0,
            tier: (row['🎖 Tier'] || '').trim(),
            trend: trend
          };
        });

      if (sorted.length === 0) {
        leaderboardDiv.innerHTML = "<p>No deals submitted this month yet.</p>";
        return;
      }

      sorted.forEach((item, i) => {
        const card = document.createElement("div");
        card.className = "rep-card";
        card.style.animationDelay = `${i * 0.1}s`;

        if (i === 0) {
          card.classList.add("gold", "glow");
          confetti({ particleCount: 150, spread: 100, origin: { y: 0.4 }, startVelocity: 40, ticks: 300 });
        } else if (i === 1) card.classList.add("silver");
        else if (i === 2) card.classList.add("bronze");

        let badgeClass = "";
        let emoji = "";
        if (item.tier === "LEGEND") { badgeClass = "legend"; emoji = "🏆"; }
        else if (item.tier === "PRO") { badgeClass = "pro"; emoji = "💼"; }
        else if (item.tier === "RISING") { badgeClass = "rising"; emoji = "🚀"; }
        else { badgeClass = "grinding"; emoji = "🔄"; }

        card.innerHTML = `
          <div class="rank">${item.rank} <span class="trend-arrow">${item.trend}</span></div>
          <h2>${item.name}</h2>
          <div class="role">${item.role}</div>
          <div class="deals">${item.count} Deal${item.count > 1 ? 's' : ''}</div>
          <div class="badge ${badgeClass}">${emoji} ${item.tier}</div>
        `;

        leaderboardDiv.appendChild(card);
      });
    } catch (error) {
      document.getElementById("leaderboard").innerHTML = "<p>Error loading leaderboard data.</p>";
      console.error(error);
    }
  }

  loadLeaderboard();
</script>
